#!/bin/bash
#
#	XBMC Language Filter
# 
#	Created by Brock Haymond 9/6/12.
#	Copyright (c) 2012 Brock Haymond <http://brockhaymond.com>.  All rights reserved.
#
# 	Bash script to call perl script "parse_srt.pl" recursively, capture running time, and output the logfile.
#

if [ "$#" -lt 1 ]
then
	echo ""
	echo "XBMC Language Filter by Brock Haymond (v1.0)"
	echo "Usage: ./xbmclf [subtitle.srt] or [subtitles folder]" 
	echo "(Press enter to close)"
	read pause
	exit 1
fi

begin=`perl -MTime::HiRes -e 'print(1*Time::HiRes::gettimeofday),"\n"'`

export TERM=xterm-color

echo "Creating XBMC compatible .edl file"

NOW=$(date +"%r %m-%d-%Y")
echo "Logfile was generated by XBMC Language Filter at $NOW">~/"XBMC Language Filter.log"

INDEX=0
function RECURSE {
for FILE in "$@"
do
	if [ -d "$FILE" ]
	then 
		for F in "$FILE/"*
		do
			RECURSE "$F"

		done
	else 
		if [[ ${FILE: -4} == ".srt" ]]
		then
		  echo "Processing "$FILE"..." | tee -a ~/"XBMC Language Filter.log" 
		  NEW=$RESULT`perl parse_srt.pl "$FILE"`
		  if [ -z "$NEW" ]
		  then
		    INDEX=`expr $INDEX + 1`
		  else
		    RESULT="$NEW"
		  fi
		  
		fi
	fi
done  
}
RECURSE "$@"

end=`perl -MTime::HiRes -e 'print(1*Time::HiRes::gettimeofday),"\n"'`
printf -v TIME "%0.3F"  $(echo "$end - $begin"|bc )

if [ -z "$RESULT" ]
then
  echo "$INDEX file(s) successfully processed in $TIME seconds."
  echo "A subtitle.edl has been created and placed in the same directory as the original subtitle.srt."
  echo "Enjoy!"

  RESULT="$INDEX file(s) successfully processed in $TIME seconds.\nA subtitle.edl has been created and placed in the same directory as the original subtitle.srt."

else
  echo "There were build errors, please check the log file in your home directory."
  echo "$INDEX file(s) successfully processed in $TIME seconds."
  echo $RESULT

  RESULT="$INDEX file(s) successfully processed in $TIME seconds.\n$RESULT"

fi

echo -e $RESULT>>~/"XBMC Language Filter.log"
