#!/bin/bash
#
#	XBMC Language Filter
# 
#	Created by Brock Haymond 9/6/12.
#	Copyright (c) 2012 Brock Haymond <http://brockhaymond.com>.  All rights reserved.
#
# 	Bash script to call perl script "parse_srt.pl" recursively, capture running time, and output the logfile.
#	
#	This script is designed to work specifically with Platypus.
#

if [ "$#" -lt 1 ]
then
	echo "Usage: parse_srt.pl [subtitle.srt] or [subtitles folder]" 
	exit 1
fi

begin=`perl -MTime::HiRes -e 'print(1*Time::HiRes::gettimeofday),"\n"'`

export TERM=xterm-color

echo "Creating XBMC compatible .edl file"

NOW=$(date +"%r %m-%d-%Y")
echo "Logfile was generated by XBMC Language Filter at $NOW">~/"XBMC Language Filter.log"

INDEX=0
function RECURSE {
for FILE in "$@"
do
	if [ -d "$FILE" ]
	then 
		for F in "$FILE/"*
		do
			RECURSE "$F"

		done
	else 
		if [[ ${FILE: -4} == ".srt" ]]
		then
		  echo "Processing "$FILE"..." | tee -a ~/"XBMC Language Filter.log" 
		  NEW=$RESULT`perl parse_srt.pl "$FILE"`
		  if [ -z "$NEW" ]
		  then
		    INDEX=`expr $INDEX + 1`
		  else
		    RESULT="$NEW"
		  fi
		  
		fi
	fi
done  
}
RECURSE "$@"

end=`perl -MTime::HiRes -e 'print(1*Time::HiRes::gettimeofday),"\n"'`
printf -v TIME "%0.3F"  $(echo "$end - $begin"|bc )

if [ -z "$RESULT" ]
then
  echo "Enjoy!"
  RESULT="$INDEX subtitle(s) successfully processed in $TIME seconds.\nAn EDL file has been created and placed in the same directory as the original SRT file."
/usr/bin/osascript << EOT
tell app "XBMC Language Filter"
	 Activate
	 display alert "EDL Build Completed" message "$RESULT" 
end tell                           
EOT

else
  echo "There were build errors, please check the log file in your home directory."
  RESULT="$INDEX subtitle(s) successfully processed in $TIME seconds.\n$RESULT"
  /usr/bin/osascript << EOT
tell app "XBMC Language Filter"
	 Activate
	 display alert "EDL Build Failed" message "$RESULT" 
end tell                           
EOT

fi

echo -e $RESULT>>~/"XBMC Language Filter.log"
